<?php

class LearningCellsController extends VanillaController {
	
	function beforeAction () {		$this->set('username',performAction('users','isLogin',array()));		$this->set('id',$_SESSION['id']);		$this->set('type',$_SESSION['type']);		$_SESSION['module']='lc';
	}
	function room($room_id){		$exist = $this->Learningcell->custom("select * from learningcells where id = ".$room_id.";");		if(@count($exist)==0):			$this->set('error','Room does not exist or closed');		else:			//check if user exist			//true			if($_SESSION['type']=="student"):				$cur=performAction("learningcells","isActive",array($room_id));				if(3!=$cur){					if($cur==2)						$this->set('block','You are blocked');				}elseif(performAction("learningcells","isOpen",array($room_id))){					performAction("learningcells","addMember",array($room_id));				}else{					$this->set('error','Invalid access');					$error="";				}			endif;			if(!isset($error)):				$_SESSION['room_id']=$room_id;			endif;			$learningcell = $this->Learningcell->custom("select * from learningcells where id = $room_id;");			$messages = $this->Learningcell->custom("select a.*, b.firstname, b.lastname from learningcellmessages a inner join users b on a.user_id = b.id where a.learningcell_id = ".$room_id." order by a.id desc;");			$replies = $this->Learningcell->custom("select a.*, b.firstname, b.lastname from learningcellreplies a inner join users b on a.user_id = b.id inner join learningcellmessages c on a.learningcellmessage_id = c.id where c.learningcell_id = ".$room_id.";");						$message_id = @count($messages)>0?$this->Learningcell->custom("select a.*, b.firstname, b.lastname from learningcellmessages a inner join users b on a.user_id = b.id where a.learningcell_id = ".$room_id." order by a.id desc limit 1;"):array(array('A'=>array('id'=>0)));			$reply_id = @count($replies)>0?$this->Learningcell->custom("select a.*, b.firstname, b.lastname from learningcellreplies a inner join users b on a.user_id = b.id inner join learningcellmessages c on a.learningcellmessage_id = c.id where c.learningcell_id = ".$room_id." and b.id = ".$_SESSION['id']." limit 1;"):array(array('A'=>array('id'=>0)));						$this->set('learningcell',$learningcell[0]['Learningcell']);			$this->set('messages',$messages);			$this->set('replies',$replies);			$this->set('message_id',$message_id[0]['A']['id']);			$this->set('reply_id',$reply_id[0]['A']['id']);		endif;
	}		function isActive($room_id){		$active = $this->Learningcell->custom("select user_status from learningcellrooms where user_id = ".$_SESSION['id']." and learningcell_id = ".$room_id.";");		$status=$active!=null?$active[0]['Learningcellroom']['user_status']:"empty";		if($status=="open"):			return 1;		elseif($status=="close"):			return 2;		endif;		return 3;	}		function isOpen($room_id){		$open = $this->Learningcell->custom("select status from learningcells where id = ".$room_id.";");		$status = $open[0]['Learningcell']['status'];		if($status=="open"):			return true;		endif;		return false;	}		function addMember($room_id){		$add = $this->Learningcell->custom("insert into learningcellrooms (learningcell_id,user_id) values (".$room_id.",".$_SESSION['id'].");");		performAction("learningcells","checkQuota",array($room_id));	}
	function index() {		if($_SESSION['type']=="student"):			$user=$this->Learningcell->custom("select aaa.* from(select aa.*, count(bb.user_id) as 'count' from(select a.*, b.firstname as `firstname`, b.lastname as `lastname` from learningcells as a inner join users b on a.teacher_id = b.id) as aa left join learningcellrooms bb on aa.id = bb.learningcell_id group by aa.id order by aa.title) as aaa inner join learningcellrooms bbb on aaa.id = bbb.learningcell_id where bbb.user_id = ".$_SESSION['id'].";");		endif;		if($_SESSION['type']!="student"):			$user=$this->Learningcell->custom("select aaa.* from(select aa.*, count(bb.user_id) as 'count' from(select a.*, b.firstname as `firstname`, b.lastname as `lastname` from learningcells as a inner join users b on a.teacher_id = b.id where a.teacher_id = ".$_SESSION['id'].") as aa left join learningcellrooms bb on aa.id = bb.learningcell_id group by aa.id order by aa.title) as aaa");		endif;		$available=$this->Learningcell->custom("select aa.*, count(bb.user_id) as `count` from(select a.*, b.firstname as `firstname`, b.lastname as `lastname` from learningcells as a inner join users b on a.teacher_id = b.id where a.status = 'open') as aa left join learningcellrooms bb on aa.id = bb.learningcell_id group by aa.id order by aa.title;");		if($_SESSION['type']=="admin"):			$available=$this->Learningcell->custom("select aa.*, count(bb.user_id) as `count` from(select a.*, b.firstname as `firstname`, b.lastname as `lastname` from learningcells as a inner join users b on a.teacher_id = b.id) as aa left join learningcellrooms bb on aa.id = bb.learningcell_id group by aa.id order by aa.title;");		endif;		$this->set('user_learningcell',$user);		$this->set('available',$available);
	}
	function loadMessage(){		$message_id=$_POST['id'];		$message = $this->Learningcell->custom("select a.*, b.firstname, b.lastname from learningcellmessages a inner join users b on a.user_id = b.id where a.id > ".$message_id." and a.learningcell_id = ".$_SESSION['room_id']." order by a.id asc limit 1;");		$count=@count($message[0]);		$this->set('message_id',$message_id);		if($count>0):			$this->set('message',$message[0]);			$this->set('message_id',$message[0]['A']['id']);		endif;		$this->set('query',"select a.*, b.firstname, b.lastname from learningcellmessages a inner join users b on a.user_id = b.id where a.id > ".$message_id." and a.learningcell_id = ".$_SESSION['room_id']." order by a.id asc limit 1;");	}		function removeMessage(){		$id=$_POST['id'];		//$id=0;		$this->Learningcell->custom("delete from learningcellmessages where id = ".$id);		//$this->set("error","delete from learningcellmessages where id = ".$id);	}		function addMessage(){		if($_SESSION['type']=="student"):			$cur=performAction("learningcells","isActive",array($_SESSION['room_id']));			if($cur==1):				$msg=$_POST['msg'];				$msg=addslashes($msg);				$this->Learningcell->custom("insert into learningcellmessages (learningcell_id,user_id,message,date_created) values (".$_SESSION['room_id'].",".$_SESSION['id'].",'".$msg."',now());");				//$this->set("error","Error happend");			endif;		else:			$message=$_POST['msg'];			//$msg=str_replace("'", "\"", $message);			$msg=$_POST['msg'];			$msg=addslashes($msg);			$this->Learningcell->custom("insert into learningcellmessages (learningcell_id,user_id,message,date_created) values (".$_SESSION['room_id'].",".$_SESSION['id'].",'".$msg."',now());");			//$this->set("error","Error happend");		endif;	}		function starMessage(){		$id=$_POST['id'];		$star=$_POST['star'];		$next=$star=="Star"?"Star":"none";		$this->Learningcell->custom("update learningcellmessages set status = '".$next."' where id = ".$id.";");		//$this->set("error","Error happend");	}		function loadMedia(){		$tags=$this->Learningcell->custom("select * from fonetags;");		$media=array();		foreach($tags as $t):			$tag=explode('_',$t['Fonetag']['module_id']);			if($tag[0]=="lc"&&$tag[1]==$_SESSION['room_id']):				$file=$this->Learningcell->custom("select * from fones where id = ".$t['Fonetag']['fone_id'].";");				array_push($media,$file);			endif;		endforeach;		$this->set('media',$media);		if(isset($_POST['id'])&&$_POST['id']!="undefined")			$this->set('current',$_POST['id']);	}		function studentList(){		$students=$this->Learningcell->custom("select aa.*, bb.count from (select a.*, b.firstname, b.lastname from learningcellrooms a inner join users b on a.user_id = b.id) as aa left join (select learningcell_id, user_id, count(`status` = 'Star' or null) 'count' from learningcellmessages group by learningcell_id, user_id) as bb on aa.user_id = bb.user_id where aa.learningcell_id = ".$_SESSION['room_id']." group by aa.user_id;");		$this->set('students',$students);	}		function blockStudent($id){		$status=$this->Learningcell->custom("select * from learningcellrooms where learningcell_id =".$_SESSION['room_id']." and user_id = ".$id.";");		$cur=$status[0]['Learningcellroom']['user_status'];		$next=$cur=='open'?'close':'open';		$update=$this->Learningcell->custom("update learningcellrooms set user_status = '".$next."' where learningcell_id =".$_SESSION['room_id']." and user_id = ".$id.";");		header("location:".ip."utopia/learningcells/studentList");	}		function removeStudent($id){		if($_SESSION['type']!="student"):		//delete from learningcellmessages where id = ".$id			$block=$this->Learningcell->custom("delete from learningcellrooms where learningcell_id = ".$_SESSION['room_id']." and user_id = ".$id);			$remove=$this->Learningcell->custom("delete from learningcellmessages where learningcell_id = ".$_SESSION['room_id']." and user_id = ".$id);			performAction("learningcells","checkQuota",array($room_id));			header("location:".ip."utopia/learningcells/studentList");		endif;	}		function create(){			}		function save(){		if(isset($_POST['title'])):			$title=$_POST['title'];			$quota=$_POST['quota'];		endif;		performAction("learningcells","checkQuota",array($_POST['id']));		$status=$_POST['status']=="public"?"open":"close";		/*$this->Learningcell->title=$title;		$this->Learningcell->quota=$quota;		$this->Learningcell->status=$status;		$this->Learningcell->date_created=" now()";*/		if(isset($_POST['id'])):			$this->Learningcell->id=$_POST['id'];			$lc=$this->Learningcell->search();			if($lc['Learningcell']['status']=="open")				$this->Learningcell->custom("update learningcells set status = '$status' where id = ".$_POST['id'].";");			header("location:".ip."utopia/learningcells/index");		else:			$this->Learningcell->custom("insert into learningcells (title, teacher_id, quota, `status`, date_created) values ('$title',".$_SESSION['id'].",$quota,'$status',now());");			$last_id=$this->Learningcell->custom("select * from learningcells where teacher_id = ".$_SESSION['id']." order by date_created desc limit 1;");			header("location:".ip."utopia/learningcells/edit/".$last_id[0]['Learningcell']['id']);		endif;	}		function edit($room_id){		$this->Learningcell->id=$room_id;		$lc=$this->Learningcell->search();		$this->set('room_id',$room_id);		$this->set('lc',$lc);	}		function close($room_id){		$this->Learningcell->id=$room_id;		$this->Learningcell->delete();		$room=$this->Learningcell->custom("select * from learningcellrooms where learingcell_id = $room_id");		foreach($room as $s):			$id=$s['Learningcellroom']['user_id'];			$this->Learningcell->custom("delete from learningcellrooms where learningcell_id = ".$room_id." and user_id = ".$id.";");			$this->Learningcell->custom("delete from learningcellmessages where learningcell_id = ".$room_id." and user_id = ".$id.";");		endforeach;		header("location:".ip."utopia/learningcells/index");	}		function search(){		$room=$_POST['room'];		$word=$_POST['word'];		if($word==""):			$cur=$this->Learningcell->custom("select * from users where type = 'student' having id in (select user_id from learningcellrooms where learningcell_id = $room);");			$avai=$this->Learningcell->custom("select * from users where type = 'student' having id not in (select user_id from learningcellrooms where learningcell_id = $room);");		else:			$cur=$this->Learningcell->custom("select * from users where type = 'student' and (lastname like '%$word%' or middlename like '%$word%' or firstname like '%$word%') having id in (select user_id from learningcellrooms where learningcell_id = $room);");			$avai=$this->Learningcell->custom("select * from users where type = 'student' and (lastname like '%$word%' or middlename like '%$word%' or firstname like '%$word%') having id not in (select user_id from learningcellrooms where learningcell_id = $room);");		endif;		$this->set('msg',"select * from users where type = 'student' and (lastname = '$word' or middlename = '$word' or firstname = '$word') having id not in (select user_id from learningcellrooms where learningcell_id = $room);");		$this->set('cur',$cur);		$this->set('avai',$avai);				$this->Learningcell->id=$room;		$lc=$this->Learningcell->search();		$total=$this->Learningcell->custom("select count(*) as 'count' from learningcellrooms where learningcell_id = $room;");		$status=$lc['Learningcell']['quota']>$total[0]['']['count']?"Open slot":"Full slot";		$this->set('status',$status);	}		function setMember(){		$room_id=$_POST['room'];		$id=$_POST['id'];		$action=$_POST['action'];		if($action=="add"):			$this->Learningcell->custom("insert into learningcellrooms (learningcell_id,user_id) values (".$room_id.",".$id.");");		else:			$this->Learningcell->custom("delete from learningcellrooms where learningcell_id = ".$room_id." and user_id = ".$id.";");			$this->Learningcell->custom("delete from learningcellmessages where learningcell_id = ".$room_id." and user_id = ".$id.";");		endif;		performAction("learningcells","checkQuota",array($room_id));	}		function checkQuota($room_id){		$this->Learningcell->id=$room_id;		$lc=$this->Learningcell->search();		$total=$this->Learningcell->custom("select count(*) as 'count' from learningcellrooms where learningcell_id = $room_id;");		$status=$lc['Learningcell']['quota']>$total[0]['']['count']?"open":"close";		$this->Learningcell->custom("update learningcells set `status` = '$status' where id = $room_id");	}	
	function afterAction() {
	}


}