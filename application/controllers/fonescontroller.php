<?php
//buggy, fix double title, make preview
class FonesController extends VanillaController {
	
	function beforeAction () {
		$this->set('username',performAction('users','isLogin',array()));		$this->set('id',$_SESSION['id']);		$this->set('type',$_SESSION['type']);		$_SESSION['module']='f1';
	}
	function index() {
		$allow=$this->Fone->custom("select * from pifs where teacher_id = ".$_SESSION['id'].";");		if(@count($allow)>0)$this->set('allow','');		$list = $this->Fone->custom("select a.*, b.module_id from fones a inner join fonetags b on a.id = b.fone_id where a.status ='public';");		$f1 = array();		foreach($list as $l):			$pattern = explode('_',$l['B']['module_id']);			$module=$pattern[0];			$id=$pattern[1];			switch($module):				case 'lc':					$user=$this->Fone->custom("select a.id, a.title, b.* from learningcells a inner join users b where a.teacher_id = b.id and a.id = $id;");					break;				case 'pif':					break;				case 'bm':					break;			endswitch;			array_push($f1,array($l,$user,$module));		endforeach;		$this->set('f1',$f1);				$user1=$this->Fone->custom("select a.id, a.title, b.* from learningcells a inner join users b where a.teacher_id = b.id and b.id = ".$_SESSION['id'].";");		$user2=$this->Fone->custom("select a.id, a.title, b.* from pifs a inner join users b where a.teacher_id = b.id and b.id = ".$_SESSION['id'].";");		$user3=$this->Fone->custom("select a.id, a.title, b.* from bfmeetings a inner join users b where a.teacher_id = b.id and b.id = ".$_SESSION['id'].";");				$f1 = array();		//get lc files		foreach($user1 as $u):			$room_id = $u['A']['id'];			$list = $this->Fone->custom("select a.*, b.module_id from fones a inner join fonetags b on a.id = b.fone_id where b.module_id = 'lc_$room_id';");			$module="lc";			if(@count($list)>0)			foreach($list as $l):				array_push($f1,array($l,$u,$module));			endforeach;		endforeach;		foreach($user2 as $u):			$room_id = $u['A']['id'];			$list = $this->Fone->custom("select a.*, b.module_id from fones a inner join fonetags b on a.id = b.fone_id where b.module_id = 'pif_$room_id';");			$module="pif";			if(@count($list)>0)			foreach($list as $l):				array_push($f1,array($l,$u,$module));			endforeach;		endforeach;		foreach($user3 as $u):			$room_id = $u['A']['id'];			$list = $this->Fone->custom("select a.*, b.module_id from fones a inner join fonetags b on a.id = b.fone_id where b.module_id = 'bm_$room_id';");			$module="bm";			if(@count($list)>0)			foreach($list as $l):				array_push($f1,array($l,$u,$module));			endforeach;		endforeach;		$this->set('cur',$f1);
	}
	function upload(){		if(isset($_POST['module'])):			$mod=$_POST['module'];			$mod_id=$_POST['module_id'];			$this->set('module',$mod);			$this->set('module_id',$mod_id);			switch($mod):				case 'lc':$moddb="learningcells";					break;				case 'pif':$moddb="pifs";					break;				case 'bm':$moddb="bfmeetings";					break;			endswitch;			$title=$this->Fone->custom("select * from $moddb a where id = $mod_id");			$this->set('title',$title[0]['A']['title']);		endif;	}		function save(){		$title=$_POST['file_title'];		$status=$_POST['status'];		if(isset($_FILES['file']['name'])):			if($_FILES['file']['name']!=''):				$fileupload = $_FILES['file']['name'];				$exts=strrchr($fileupload[0], '.');				$filename = uniqid().$exts;				$type=$_FILES['file']['type'][0];				$size=$_FILES['file']['size'][0];				$images=array('image/jpeg','image/jpg','image/png','image/gif');				if(in_array($type,$images)):					$type='image';					$dir = ROOT . DS . "public" . DS . "image" . DS . $filename;				else:					$type='other';					$dir = ROOT . DS . "public" . DS . "other" . DS . $filename;				endif;				if(move_uploaded_file($_FILES['file']["tmp_name"][0], $dir)):					$this->Fone->custom("insert into fones (filename,title,type,size,status) values('$filename','$title','$type','$size','$status');");				endif;				$f1=$this->Fone->custom("select * from fones order by id desc limit 1;");				$id=$f1[0]['Fone']['id'];				if(isset($_POST['module_name'])):					$module=$_POST['module_name'];					$moduleid=$_POST['module_id'];					$this->Fone->custom("insert into fonetags values ($id,'".$module."_$moduleid');");					header("location: ".ip."utopia/fones/index");				else:					header("location: ".ip."utopia/fones/edit/$id");				endif;							else:							endif;		else:			$id=$_POST['file_id'];			$this->Fone->custom("update fones set title = '$title', status = '$status' where id = $id");			header("location: ".ip."utopia/fones/index");		endif;	}		function link($link=0){		if($link!=0):			$ref=$this->Fone->custom("select * from `references` where id = ".$link.";");			$title= $ref[0]['Reference']['title'];			$links= $ref[0]['Reference']['link'];			$this->set('title',$title);			$this->set('link',$links);			$this->set('q',"select * from references where id = $link;");		elseif(isset($_POST['module'])):			$mod=$_POST['module'];			$mod_id=$_POST['module_id'];			$this->set('module',$mod);			$this->set('module_id',$mod_id);			switch($mod):				case 'lc':$moddb="learningcells";					break;				case 'pif':$moddb="pifs";					break;				case 'bm':$moddb="bfmeetings";					break;			endswitch;			$title=$this->Fone->custom("select * from $moddb a where id = $mod_id");			$this->set('title',$title[0]['A']['title']);		endif;	}		function savelink(){		$title=$_POST['file_title'];		$status=$_POST['status'];		if(isset($_POST['link'])):			$filename=$_POST['link'];			$this->Fone->custom("insert into fones (filename,title,type,size,status) values('$filename','$title','video','','$status');");			$f1=$this->Fone->custom("select * from fones order by id desc limit 1;");			$id=$f1[0]['Fone']['id'];			if(isset($_POST['module_name'])):				$module=$_POST['module_name'];				$moduleid=$_POST['module_id'];				$this->Fone->custom("insert into fonetags values ($id,'".$module."_$moduleid');");				header("location: ".ip."utopia/fones/index");			else:				header("location: ".ip."utopia/fones/edit/$id");			endif;		else:			$id=$_POST['file_id'];			$this->Fone->custom("update fones set title = '$title', status = '$status' where id = $id");			header("location: ".ip."utopia/fones/index");		endif;	}		function editlink($id){		$this->Fone->id=$id;		$f1=$this->Fone->search();		$this->set('id',$id);		$this->set('f1',$f1);	}		function edit($id){		$this->Fone->id=$id;		$f1=$this->Fone->search();		$this->set('id',$id);		$this->set('f1',$f1);	}		function delete($id){		$this->Fone->custom("delete from fones where id = $id;");		$this->Fone->custom("delete from fonetags where fone_id = $id");		header("location: ".ip."utopia/fones/index");	}		function tag($module="",$module_id=0){		if($module_id==0)://from f1			$file_id=$_POST['file_id'];			$tags=$this->Fone->custom("select * from fonetags where fone_id = $file_id;");			$tag = array();			$free = array();			$existLC=array();			$existPIF=array();			$existBM=array();			foreach($tags as $t):				$pattern = explode('_',$t['Fonetag']['module_id']);				$mod=$pattern[0];				$mod_id=$pattern[1];				switch($mod):					case 'lc':						$moddb="learningcells";						array_push($existLC,$mod_id);						break;					case 'pif':						$moddb="pifs";						array_push($existPIF,$mod_id);						break;					case 'bm':						$moddb="bfmeetings";						array_push($existBM,$mod_id);						break;				endswitch;				$detail=$this->Fone->custom("select a.* from $moddb a where a.id = $mod_id;");				array_push($tag,array($t,$detail,$mod));			endforeach;						$count=@count($tags);			$this->set('count',$count);			$this->set('tag',$tag);												$detail2=$this->Fone->custom("select a.* from learningcells a where teacher_id = ".$_SESSION['id'].";");			if($type=="admin")				$detail2=$this->Fone->custom("select a.* from learningcells a;");			if(@count($detail2)>0):				foreach($detail2 as $d):					if(!in_array($d['A']['id'],$existLC))						array_push($free,array(array($d),'lc'));				endforeach;			endif;			$detail2=$this->Fone->custom("select a.* from pifs a where teacher_id = ".$_SESSION['id'].";");			if($type=="admin")				$detail2=$this->Fone->custom("select a.* from pifs a;");			if(@count($detail2)>0):				foreach($detail2 as $d):					if(!in_array($d['A']['id'],$existPIF))						array_push($free,array(array($d),'pif'));				endforeach;			endif;			$detail2=$this->Fone->custom("select a.* from bfmeetings a where teacher_id = ".$_SESSION['id'].";");			if($type=="admin")				$detail2=$this->Fone->custom("select a.* from bfmeetings a;");			if(@count($detail2)>0):				foreach($detail2 as $d):					if(!in_array($d['A']['id'],$existBM))						array_push($free,array(array($d),'bm'));				endforeach;			endif;			$this->set('free',$free);		endif;	}		function setTag(){		$id=$_POST['id'];		$module_id=$_POST['mod'];		$exist=$this->Fone->custom("select * from fonetags where fone_id = $id and module_id = '$module_id';");		$count=@count($exist);		if($count==0):			$this->Fone->custom("insert into fonetags values ($id,'$module_id');");		else:			$this->Fone->custom("delete from fonetags where fone_id = $id and module_id = '$module_id';");		endif;	}		function reference(){		$list=$this->Fone->custom("select * from `references` a order by title asc;");		$this->set('list',$list);	}
	function afterAction() {

	}


}