<?php

class PifsController extends VanillaController {
		function beforeAction () {		$this->set('username',performAction('users','isLogin',array()));		$this->set('id',$_SESSION['id']);		$this->set('type',$_SESSION['type']);		$_SESSION['module']='pif';	}	function room($room_id){		$exist = $this->Pif->custom("select * from pifs where id = ".$room_id.";");		if(@count($exist)==0):			$this->set('error','Room does not exist or closed');		else:			//check if user exist			//true			$exist=$this->Pif->custom("select * from pifs where teacher_id = ".$_SESSION['id'].";");			if(@count($exist)==0):				$cur=performAction("pifs","isActive",array($room_id));				if(3!=$cur){					if($cur==2)						$this->set('block','You are blocked');				}elseif(performAction("pifs","isOpen",array($room_id))){					performAction("pifs","addMember",array($room_id));				}else{					$this->set('error','Invalid access');					$error="";				}			endif;			if(!isset($error)):				$_SESSION['room_id']=$room_id;			endif;			$pif = $this->Pif->custom("select * from pifs where id = $room_id;");			$messages = $this->Pif->custom("select a.*, b.firstname, b.lastname from pifmessages a inner join users b on a.user_id = b.id where a.pif_id = ".$room_id." order by a.id desc;");			//$replies = $this->Pif->custom("select a.*, b.firstname, b.lastname from learningcellreplies a inner join users b on a.user_id = b.id inner join learningcellmessages c on a.learningcellmessage_id = c.id where c.learningcell_id = ".$room_id.";");						$message_id = @count($messages)>0?$this->Pif->custom("select a.*, b.firstname, b.lastname from pifmessages a inner join users b on a.user_id = b.id where a.pif_id = ".$room_id." order by a.id desc limit 1;"):array(array('A'=>array('id'=>0)));			//$reply_id = @count($replies)>0?$this->Pif->custom("select a.*, b.firstname, b.lastname from learningcellreplies a inner join users b on a.user_id = b.id inner join learningcellmessages c on a.learningcellmessage_id = c.id where c.learningcell_id = ".$room_id." and b.id = ".$_SESSION['id']." limit 1;"):array(array('A'=>array('id'=>0)));						$this->set('learningcell',$pif[0]['Pif']);			$this->set('messages',$messages);			//$this->set('replies',$replies);			$this->set('message_id',$message_id[0]['A']['id']);			//$this->set('reply_id',$reply_id[0]['A']['id']);		endif;	}		function isActive($room_id){		$active = $this->Pif->custom("select user_status from pifrooms where user_id = ".$_SESSION['id']." and pif_id = ".$room_id.";");		$status=$active!=null?$active[0]['Pif']['user_status']:"empty";		if($status=="open"):			return 1;		elseif($status=="close"):			return 2;		endif;		return 3;	}		function isOpen($room_id){		$open = $this->Pif->custom("select status from pifs where id = ".$room_id.";");		$status = $open[0]['Pif']['status'];		if($status=="open"):			return true;		endif;		return false;	}		function addMember($room_id){		$add = $this->Pif->custom("insert into pifrooms (pif_id,user_id) values (".$room_id.",".$_SESSION['id'].");");		performAction("pifs","checkQuota",array($room_id));	}	function index() {		$exist=$this->Pif->custom("select * from pifs where teacher_id = ".$_SESSION['id'].";");		if(@count($exist)==0):			$user=$this->Pif->custom("select aaa.* from(select aa.*, count(bb.user_id) as 'count' from(select a.*, b.firstname as `firstname`, b.lastname as `lastname` from pifs as a inner join users b on a.teacher_id = b.id) as aa left join pifrooms bb on aa.id = bb.pif_id group by aa.id order by aa.title) as aaa inner join pifrooms bbb on aaa.id = bbb.pif_id where bbb.user_id = ".$_SESSION['id'].";");		else:			$user=$this->Pif->custom("select aaa.* from(select aa.*, count(bb.user_id) as 'count' from(select a.*, b.firstname as `firstname`, b.lastname as `lastname` from pifs as a inner join users b on a.teacher_id = b.id where a.teacher_id = ".$_SESSION['id'].") as aa left join pifrooms bb on aa.id = bb.pif_id group by aa.id order by aa.title) as aaa");		endif;		$available=$this->Pif->custom("select aa.*, count(bb.user_id) as `count` from(select a.*, b.firstname as `firstname`, b.lastname as `lastname` from pifs as a inner join users b on a.teacher_id = b.id where a.status = 'open') as aa left join pifrooms bb on aa.id = bb.pif_id group by aa.id order by aa.title;");		if($_SESSION['type']=="admin"):			$available=$this->Pif->custom("select aa.*, count(bb.user_id) as `count` from(select a.*, b.firstname as `firstname`, b.lastname as `lastname` from pifs as a inner join users b on a.teacher_id = b.id) as aa left join pifrooms bb on aa.id = bb.pif_id group by aa.id order by aa.title;");		endif;		$this->set('user_learningcell',$user);		$this->set('available',$available);	}	function loadMessage(){		$message_id=$_POST['id'];		$message = $this->Pif->custom("select a.*, b.firstname, b.lastname from pifmessages a inner join users b on a.user_id = b.id where a.id > ".$message_id." and a.pif_id = ".$_SESSION['room_id']." order by a.id asc limit 1;");		$count=@count($message[0]);		$this->set('message_id',$message_id);		if($count>0):			$this->set('message',$message[0]);			$this->set('message_id',$message[0]['A']['id']);		endif;		$this->set('query',"select a.*, b.firstname, b.lastname from pifmessages a inner join users b on a.user_id = b.id where a.id > ".$message_id." and a.pif_id = ".$_SESSION['room_id']." order by a.id asc limit 1;");	}		function removeMessage(){		$id=$_POST['id'];		//$id=0;		$this->Pif->custom("delete from pifmessages where id = ".$id);		//$this->set("error","delete from learningcellmessages where id = ".$id);	}		function addMessage(){		$exist = $this->Pif->custom("select * from pifs where teacher_id = ".$_SESSION['id'].";");		if(@count($exist)==0):			$cur=performAction("pifs","isActive",array($_SESSION['room_id']));			if($cur==1):				$msg=$_POST['msg'];				$msg=addslashes($msg);				$this->Pif->custom("insert into pifmessages (pif_id,user_id,message,date_created) values (".$_SESSION['room_id'].",".$_SESSION['id'].",'".$msg."',now());");				//$this->set("error","Error happend");			endif;		else:			$message=$_POST['msg'];			//$msg=str_replace("'", "\"", $message);			$msg=$_POST['msg'];			$msg=addslashes($msg);			$this->Pif->custom("insert into pifmessages (pif_id,user_id,message,date_created) values (".$_SESSION['room_id'].",".$_SESSION['id'].",'".$msg."',now());");			//$this->set("error","Error happend");		endif;	}		function starMessage(){		$id=$_POST['id'];		$star=$_POST['star'];		$next=$star=="Star"?"Star":"none";		$this->Pif->custom("update pifmessages set status = '".$next."' where id = ".$id.";");		//$this->set("error","Error happend");	}		function loadMedia(){		$tags=$this->Pif->custom("select * from fonetags;");		$media=array();		foreach($tags as $t):			$tag=explode('_',$t['Fonetag']['module_id']);			if($tag[0]=="pif"&&$tag[1]==$_SESSION['room_id']):				$file=$this->Pif->custom("select * from fones where id = ".$t['Fonetag']['fone_id'].";");				array_push($media,$file);			endif;		endforeach;		$this->set('media',$media);		if(isset($_POST['id'])&&$_POST['id']!="undefined")			$this->set('current',$_POST['id']);	}		function studentList(){		$students=$this->Pif->custom("select aa.*, bb.count from (select a.*, b.firstname, b.lastname from pifrooms a inner join users b on a.user_id = b.id where b.id != ".$_SESSION['id'].") as aa left join (select pif_id, user_id, count(`status` = 'Star' or null) 'count' from pifmessages group by pif_id, user_id) as bb on aa.user_id = bb.user_id where aa.pif_id = ".$_SESSION['room_id']." group by aa.user_id;");		$this->set('students',$students);	}		function blockStudent($id){		$status=$this->Pif->custom("select * from pifrooms where pif_id =".$_SESSION['room_id']." and user_id = ".$id.";");		$cur=$status[0]['Pifroom']['user_status'];		$next=$cur=='open'?'close':'open';		$update=$this->Pif->custom("update pifrooms set user_status = '".$next."' where pif_id =".$_SESSION['room_id']." and user_id = ".$id.";");		header("location:".ip."utopia/pifs/studentList");	}		function removeStudent($id){		$exist = $this->Pif->custom("select * from pifs where teacher_id = ".$_SESSION['id'].";");		if(@count($exist)>0):		//delete from learningcellmessages where id = ".$id			$block=$this->Pif->custom("delete from pifrooms where pif_id = ".$_SESSION['room_id']." and user_id = ".$id);			$remove=$this->Pif->custom("delete from pifmessages where pif_id = ".$_SESSION['room_id']." and user_id = ".$id);			performAction("pifs","checkQuota",array($room_id));			header("location:".ip."utopia/pifs/studentList");		endif;	}		function create(){			}		function save(){		if(isset($_POST['title'])):			$title=$_POST['title'];			$quota=$_POST['quota'];		endif;		performAction("pifs","checkQuota",array($_POST['id']));		$status=$_POST['status']=="public"?"open":"close";		/*$this->Pif->title=$title;		$this->Pif->quota=$quota;		$this->Pif->status=$status;		$this->Pif->date_created=" now()";*/		if(isset($_POST['id'])):			$this->Pif->id=$_POST['id'];			$lc=$this->Pif->search();			if($lc['Pif']['status']=="open")				$this->Pif->custom("update pifs set status = '$status' where id = ".$_POST['id'].";");			header("location:".ip."utopia/pifs/index");		else:			$this->Pif->custom("insert into pifs (title, teacher_id, quota, `status`, date_created) values ('$title',".$_SESSION['id'].",$quota,'$status',now());");			$last_id=$this->Pif->custom("select * from pifs where teacher_id = ".$_SESSION['id']." order by date_created desc limit 1;");			header("location:".ip."utopia/pifs/edit/".$last_id[0]['Pif']['id']);		endif;	}		function edit($room_id){		$this->Pif->id=$room_id;		$lc=$this->Pif->search();		$this->set('room_id',$room_id);		$this->set('lc',$lc);	}		function close($room_id){		$this->Pif->id=$room_id;		$this->Pif->delete();		$room=$this->Pif->custom("select * from pifrooms where pif_id = $room_id;");		foreach($room as $s):			$id=$s['Pifroom']['user_id'];			$this->Pif->custom("delete from pifrooms where pif_id = ".$room_id." and user_id = ".$id.";");			$this->Pif->custom("delete from pifmessages where pif_id = ".$room_id." and user_id = ".$id.";");		endforeach;		header("location:".ip."utopia/pifs/index");	}		/*function search(){		$room=$_POST['room'];		$word=$_POST['word'];		if($word==""):			$cur=$this->Pif->custom("select * from users where type = 'student' having id in (select user_id from pifrooms where pif_id = $room);");			$avai=$this->Pif->custom("select * from users where type = 'student' having id not in (select user_id from pifrooms where pif_id = $room);");		else:			$cur=$this->Pif->custom("select * from users where type = 'student' and (lastname like '%$word%' or middlename like '%$word%' or firstname like '%$word%') having id in (select user_id from pifrooms where pif_id = $room);");			$avai=$this->Pif->custom("select * from users where type = 'student' and (lastname like '%$word%' or middlename like '%$word%' or firstname like '%$word%') having id not in (select user_id from pifrooms where pif_id = $room);");		endif;		$this->set('msg',"select * from users where type = 'student' and (lastname = '$word' or middlename = '$word' or firstname = '$word') having id not in (select user_id from pifrooms where pif_id = $room);");		$this->set('cur',$cur);		$this->set('avai',$avai);				$this->Pif->id=$room;		$lc=$this->Pif->search();		$total=$this->Pif->custom("select count(*) as 'count' from pifrooms where pif_id = $room;");		$status=$lc['Pif']['quota']>$total[0]['']['count']?"Open slot":"Full slot";		$this->set('status',$status);	}*/		function setMember(){		$room_id=$_POST['room'];		$id=$_POST['id'];		$action=$_POST['action'];		if($action=="add"):			$this->Pif->custom("insert into pifrooms (pif_id,user_id) values (".$room_id.",".$id.");");		else:			$this->Pif->custom("delete from pifrooms where pif_id = ".$room_id." and user_id = ".$id.";");			$this->Pif->custom("delete from pifmessages where pif_id = ".$room_id." and user_id = ".$id.";");		endif;		performAction("pifs","checkQuota",array($room_id));	}		function checkQuota($room_id){		$this->Pif->id=$room_id;		$lc=$this->Pif->search();		$total=$this->Pif->custom("select count(*) as 'count' from pifrooms where pif_id = $room_id;");		$status=$lc['Pif']['quota']>$total[0]['']['count']?"open":"close";		$this->Pif->custom("update pifs set `status` = '$status' where id = $room_id");	}		function afterAction() {	}

}